// const vaiyotokenaddress = "0xBA19f24dFCf7f795D90c0404d104680dB28BAC2b"; //main
// const vaiyotokenaddress = "0x028C98fB13F551FaF5EfF0Dec5c80B98CFf706A5"; //test
// const lockvaiyoaddress = "0x428E68a2a7309224919914812c41Fa1048Abf2f6";//test
const vaiyotokenaddress = "0xBA19f24dFCf7f795D90c0404d104680dB28BAC2b"; //main
const lockvaiyoaddress = "0xE2E0C69A21a0d8550ca3FE8D6575c14B0c14D284"; //main
const busdAddress = "0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56";

const LockContractABI = [
  { inputs: [], stateMutability: "nonpayable", type: "constructor" },
  {
    anonymous: false,
    inputs: [
      {
        indexed: true,
        internalType: "address",
        name: "previousOwner",
        type: "address",
      },
      {
        indexed: true,
        internalType: "address",
        name: "newOwner",
        type: "address",
      },
    ],
    name: "OwnershipTransferred",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: false,
        internalType: "address",
        name: "token",
        type: "address",
      },
      {
        indexed: false,
        internalType: "uint256",
        name: "amount",
        type: "uint256",
      },
    ],
    name: "Recovered",
    type: "event",
  },
  {
    inputs: [{ internalType: "address", name: "add", type: "address" }],
    name: "checkTime",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "claimTokens",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [],
    name: "depositBNB",
    outputs: [],
    stateMutability: "payable",
    type: "function",
  },
  {
    inputs: [{ internalType: "uint256", name: "amnt", type: "uint256" }],
    name: "depositBUSD",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [{ internalType: "address", name: "", type: "address" }],
    name: "depositsBNB",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [{ internalType: "address", name: "", type: "address" }],
    name: "depositsBUSD",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [{ internalType: "address", name: "", type: "address" }],
    name: "deposittimes",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [{ internalType: "uint256", name: "bnbAmount", type: "uint256" }],
    name: "getBUSDAmount",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "getBUSDPerBNB",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [{ internalType: "uint256", name: "busdAmount", type: "uint256" }],
    name: "getTokensAmount",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "minDepositAmount",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "owner",
    outputs: [{ internalType: "address", name: "", type: "address" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "priceFeed",
    outputs: [
      {
        internalType: "contract AggregatorV3Interface",
        name: "",
        type: "address",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [{ internalType: "address", name: "add", type: "address" }],
    name: "read",
    outputs: [
      { internalType: "uint256", name: "", type: "uint256" },
      { internalType: "uint256", name: "", type: "uint256" },
      { internalType: "uint256", name: "", type: "uint256" },
      { internalType: "bool", name: "", type: "bool" },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [
      { internalType: "address", name: "tokenAddress", type: "address" },
      { internalType: "uint256", name: "tokenAmount", type: "uint256" },
    ],
    name: "recoverBEP20",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [{ internalType: "uint256", name: "tokenAmount", type: "uint256" }],
    name: "recoverBUSD",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [{ internalType: "uint256", name: "amount", type: "uint256" }],
    name: "releaseFunds",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [],
    name: "releaseFundsAll",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [],
    name: "renounceOwnership",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    inputs: [],
    name: "token",
    outputs: [
      { internalType: "contract VaiyoToken", name: "", type: "address" },
    ],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "totalBNB",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "totalBUSD",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [],
    name: "totallockTime",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
  {
    inputs: [{ internalType: "address", name: "newOwner", type: "address" }],
    name: "transferOwnership",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
];

const BusdContractABI = [
  {
    inputs: [],
    payable: false,
    stateMutability: "nonpayable",
    type: "constructor",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: true,
        internalType: "address",
        name: "owner",
        type: "address",
      },
      {
        indexed: true,
        internalType: "address",
        name: "spender",
        type: "address",
      },
      {
        indexed: false,
        internalType: "uint256",
        name: "value",
        type: "uint256",
      },
    ],
    name: "Approval",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      {
        indexed: true,
        internalType: "address",
        name: "previousOwner",
        type: "address",
      },
      {
        indexed: true,
        internalType: "address",
        name: "newOwner",
        type: "address",
      },
    ],
    name: "OwnershipTransferred",
    type: "event",
  },
  {
    anonymous: false,
    inputs: [
      { indexed: true, internalType: "address", name: "from", type: "address" },
      { indexed: true, internalType: "address", name: "to", type: "address" },
      {
        indexed: false,
        internalType: "uint256",
        name: "value",
        type: "uint256",
      },
    ],
    name: "Transfer",
    type: "event",
  },
  {
    constant: true,
    inputs: [],
    name: "_decimals",
    outputs: [{ internalType: "uint8", name: "", type: "uint8" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "_name",
    outputs: [{ internalType: "string", name: "", type: "string" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "_symbol",
    outputs: [{ internalType: "string", name: "", type: "string" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: true,
    inputs: [
      { internalType: "address", name: "owner", type: "address" },
      { internalType: "address", name: "spender", type: "address" },
    ],
    name: "allowance",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: false,
    inputs: [
      { internalType: "address", name: "spender", type: "address" },
      { internalType: "uint256", name: "amount", type: "uint256" },
    ],
    name: "approve",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: true,
    inputs: [{ internalType: "address", name: "account", type: "address" }],
    name: "balanceOf",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: false,
    inputs: [{ internalType: "uint256", name: "amount", type: "uint256" }],
    name: "burn",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "decimals",
    outputs: [{ internalType: "uint8", name: "", type: "uint8" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: false,
    inputs: [
      { internalType: "address", name: "spender", type: "address" },
      { internalType: "uint256", name: "subtractedValue", type: "uint256" },
    ],
    name: "decreaseAllowance",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "getOwner",
    outputs: [{ internalType: "address", name: "", type: "address" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: false,
    inputs: [
      { internalType: "address", name: "spender", type: "address" },
      { internalType: "uint256", name: "addedValue", type: "uint256" },
    ],
    name: "increaseAllowance",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: false,
    inputs: [{ internalType: "uint256", name: "amount", type: "uint256" }],
    name: "mint",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "name",
    outputs: [{ internalType: "string", name: "", type: "string" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "owner",
    outputs: [{ internalType: "address", name: "", type: "address" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: false,
    inputs: [],
    name: "renounceOwnership",
    outputs: [],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "symbol",
    outputs: [{ internalType: "string", name: "", type: "string" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: true,
    inputs: [],
    name: "totalSupply",
    outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
    payable: false,
    stateMutability: "view",
    type: "function",
  },
  {
    constant: false,
    inputs: [
      { internalType: "address", name: "recipient", type: "address" },
      { internalType: "uint256", name: "amount", type: "uint256" },
    ],
    name: "transfer",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: false,
    inputs: [
      { internalType: "address", name: "sender", type: "address" },
      { internalType: "address", name: "recipient", type: "address" },
      { internalType: "uint256", name: "amount", type: "uint256" },
    ],
    name: "transferFrom",
    outputs: [{ internalType: "bool", name: "", type: "bool" }],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
  {
    constant: false,
    inputs: [{ internalType: "address", name: "newOwner", type: "address" }],
    name: "transferOwnership",
    outputs: [],
    payable: false,
    stateMutability: "nonpayable",
    type: "function",
  },
];

// const web3 = new Web3(
//   new Web3.providers.HttpProvider()
//   //"https://mainnet.infura.io/v3/515bc6d0df73416e938446fd12ae9234"
//   //"https://bsc-dataseed.binance.org"
// );
// async function getWeb3() {
  const web3 = new Web3(window.ethereum);
//   try {
//     // Request account access if needed
//     await window.ethereum.enable();
//     // Acccounts now exposed
//     // resolve(web3);
//   } catch (error) {
//     reject(error);
//   }
//   return web3;
// }

async function getBalance(account) {
  var balance = 0;
  // const web3 = await getWeb3();
  if (web3 !== "undefined") {
    await web3.eth.getBalance(account, function (err, result) {
      if (err) {
        console.log(err);
      } else {
        balance = web3.utils.fromWei(result, "ether");
      }
    });
  }
  return balance;
};

function onCryptoMenuClick(cryptotype) {
  switch (cryptotype) {
    case "bnb":
      document.getElementById("crypto-icon").src =
        "<%= asset_path('bnb.png')%>";
      document.getElementById("crypto-name").innerHTML = "BNB";
      setSupplyBtnStatus("bnb");
      break;
    case "busd":
      document.getElementById("crypto-icon").src =
        "<%= asset_path('busd.png')%>";
      document.getElementById("crypto-name").innerHTML = "BUSD";
      setSupplyBtnStatus("busd");
      break;
    default:
    // code block
  }
  $("#crypto-dropdown-menu").collapse("toggle");
  document.getElementById("amountinput").value = "";
}

async function onbtnMax() {
  await changeNetwork();
  const user = $("#mycontainer").data("source");
  const crypto = document.getElementById("crypto-name").innerHTML;
  if (crypto == "BNB") {
    const balance = await getBalance(user.waddress);
    if (balance - 0.01 > 0)
      document.getElementById("amountinput").value = balance - 0.01;
    else document.getElementById("amountinput").value = 0;
  } else {
    //const web3 = await getWeb3();
    const BusdContract = new web3.eth.Contract(BusdContractABI, busdAddress);
    const balance = await BusdContract.methods.balanceOf(user.waddress).call();
    const ret = web3.utils.fromWei(balance, "ether");
    document.getElementById("amountinput").value = ret;
  }
}

async function setSupplyBtnStatus(crypto) {
  document.getElementById("supplybtn").innerHTML = "Supply";
  await changeNetwork();
  if (crypto == "busd") {
    const user = $("#mycontainer").data("source");
    //const web3 = await getWeb3();
    const BusdContract = new web3.eth.Contract(BusdContractABI, busdAddress);
    const allowanceStr = await BusdContract.methods
      .allowance(user.waddress, lockvaiyoaddress)
      .call();
    const balanceStr = await BusdContract.methods
      .balanceOf(user.waddress)
      .call();
    const allowance = new BigNumber(allowanceStr);
    const balance = new BigNumber(balanceStr);

    if (allowance < balance) {
      document.getElementById("supplybtn").innerHTML = "Approve";
    }
  }
}

async function approveBUSD() {
  const user = $("#mycontainer").data("source");
  //const web3 = await getWeb3();
  const BusdContract = new web3.eth.Contract(BusdContractABI, busdAddress);
  const balance = await BusdContract.methods.balanceOf(user.waddress).call();
  document.getElementById("supplybtn").disabled = true;
  await BusdContract.methods
    .approve(lockvaiyoaddress, balance)
    .send({ from: user.waddress })
    .then((data) => {
      document.getElementById("supplybtn").innerHTML = "Supply";
      document.getElementById("supplybtn").disabled = false;
    })
    .catch((e) => {
      console.log(e);
      document.getElementById("supplybtn").disabled = false;
    });
}

async function deposit() {
  await connectWithWallet("metamask", "vaiyo");
  await changeNetwork();
  const approvestate = document.getElementById("supplybtn").innerHTML;
  if (approvestate == "Approve") {
    approveBUSD();
    return;
  }
  const user = $("#mycontainer").data("source");
  let depositAmount = document.getElementById("amountinput").value;
  if (depositAmount == "") return;
  if (depositAmount == null) return;
  const amount = new BigNumber(depositAmount + "e18");
  const crypto = document.getElementById("crypto-name").innerHTML;
  //const web3 = await getWeb3();
  if (crypto == "BNB") {
    const LockContract = new web3.eth.Contract(
      LockContractABI,
      lockvaiyoaddress
    );
    document.getElementById("supplybtn").disabled = true;
    LockContract.methods
      .depositBNB()
      .send({
        from: user.waddress,
        value: amount, // in WEI, which is equivalent to 1 ether
      })
      .then((data) => {
        console.log(data);
        document.getElementById("supplybtn").disabled = false;
      })
      .catch((error) => {
        console.log("Error:", error);
        document.getElementById("supplybtn").disabled = false;
      });
  } else {
    const LockContract = new web3.eth.Contract(
      LockContractABI,
      lockvaiyoaddress
    );
    document.getElementById("supplybtn").disabled = true;
    LockContract.methods
      .depositBUSD(amount.toString())
      .send({ from: user.waddress })
      .then((data) => {
        console.log(data);
        document.getElementById("supplybtn").disabled = false;
      })
      .catch((error) => {
        console.log("Error:", error);
        document.getElementById("supplybtn").disabled = false;
      });
  }
}
